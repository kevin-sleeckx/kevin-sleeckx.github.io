<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overuren Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- PWA Manifest and Theme -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 2em; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #333; }
    .totals { padding: 1em; border-radius: 8px; font-weight: bold; margin-bottom: 1.5em; text-align: center; color: white; }
    .totals.positief { background: #28a745; }
    .totals.negatief { background: #dc3545; }

    form, table { width: 100%; background: #fff; padding: 1em; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2em; }
    label { display: block; margin-bottom: 0.6em; width: 100%; }
    input, select, button { padding: 0.5em; max-width: 100%; box-sizing: border-box; margin-top: 0.3em; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; }
    .inline-inputs { display: flex; gap: 8px; align-items: center; margin-bottom: 1em; }
    .inline-inputs input { width: 5ch; flex: 0 0 auto; }

    button { background-color: #007bff; color: white; font-weight: bold; cursor: pointer; border: none; }
    button:hover { background-color: #0056b3; }
    .hide { display: none !important; } /* Added !important to ensure it overrides inline styles if any conflict */

    table { border-collapse: collapse; font-size: 0.95em; width: 100%; border-radius: 8px; overflow: hidden; }
    th, td { border: 1px solid #ddd; padding: 0.75em; text-align: center; }
    th { background-color: #007bff; color: white; }
    tr.positief { background-color: #e6ffe6; }
    td { vertical-align: middle; }
    tr.negatief { background-color: #ffe6e6; }

    .actions i { cursor: pointer; margin: 0 5px; }
    .actions i:hover { color: #007bff; }

    .top-buttons { display: flex; justify-content: space-between; margin-bottom: 1em; flex-wrap: wrap; gap: 10px; }
    .info-box {
      display: none;
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 5px;
      width: 300px;
    }
    .question-icon {
      cursor: pointer;
      margin-left: 5px;
      color: blue;
      font-weight: bold;
    }
    .blur-toggle {
      filter: blur(6px);
      cursor: pointer;
      transition: filter 0.3s ease;
    }
    .blur-toggle.reveal {
      filter: none;
    }
    
    /* Utility classes */
    .text-center { text-align: center; }
    .export-status-message {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-weight: bold;
    }
    .amount-display-text {
      text-align: center;
      margin-top: 0.5em;
    }
    .warning-box-close-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: #856404; /* Default warning color, JS might need to adapt if box type changes */
    }
    .form-submit-wrapper {
      text-align: center;
      margin-top: 1.4em; /* Provides space above submit button */
      margin-bottom: 1em; /* Reduced from 2em as form itself has margin-bottom */
    }
    .version-info {
      text-align: center;
      color: #666;
      margin-top: -1em; /* Retained from original, check if visual is okay */
    }
    #hoursDiv.inline-inputs {
      justify-content: center;
    }
    #warningBox { /* Base styles for warning box, JS will set specific colors/bg */
        padding:10px; 
        margin-bottom:1em; 
        border-radius:4px; 
        position:relative;
    }

    @media screen and (max-width: 600px) {
      #hoursDiv.inline-inputs {
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      #hoursDiv.inline-inputs input {
        width: 4ch;
      }
      body { padding: 1em; }
      .inline-inputs { flex-direction: column; align-items: flex-start; }
      .top-buttons { flex-direction: column; align-items: stretch; }
      form, table { padding: 0.5em; }
      label, input, select, button { font-size: 1em; width: 100%; }
      .info-box { width: 100%; }
    }
  </style>
</head>
<body>
  
  <div id="totalsDisplay" class="totals">Totaal waarde overuren: €<span id="totalNet">0.00</span></div>
  
  <div class="top-buttons">
    <div id="exportStatus" class="hide export-status-message"></div>
    <button onclick="exportToPDF()">Exporteer naar PDF</button>
  </div>

  <form id="entryForm">
    <div style="display: flex; gap: 1em; align-items: flex-end; justify-content: center; margin-bottom: 1em;">
      <div>
        <button type="button" onclick="editStartAmount()">Startbedrag aanpassen</button>
        <p id="startDisplay" class="amount-display-text">Startbedrag: €<span id="startAmountDisplay" class="blur-toggle">0.00</span></p>
      </div>
      <div>
        <button type="button" onclick="editWage()">Dagloon aanpassen</button>
        <p id="wageDisplay" class="amount-display-text">Dagloon: €<span id="wageAmountDisplay" class="blur-toggle">0.00</span></p>
      </div>
    </div>

    <div id="warningBox" class="hide">
      <!-- Content set by JS -->
      <button type="button" class="warning-box-close-btn" onclick="this.parentElement.classList.add('hide')">&times;</button>
    </div>

    <div class="text-center">
      <label>Datum:
        <input type="date" id="date" required>
      </label>
    </div>
    <div class="text-center">
      <label>Type:
        <select id="entryType">
          <option value="recupPlus">Recup+</option>
          <option value="recupMin">Recup-</option>
          <option value="bestelling">Bestelling</option>
        </select>
      </label>
    </div>
    <div class="text-center">
      <label id="shiftLabel">Shift:
        <select id="shift">
          <option value="dag">Dag</option>
          <option value="vroeg">Vroege</option>
          <option value="laat">Late</option>
          <option value="nacht">Nacht</option>
        </select>
      </label>
    </div>
    <div class="text-center">
      <span class="question-icon" onclick="toggleInfoBox()"><i class="fas fa-question-circle"></i></span>
      <div id="infoBox" class="info-box">
        <strong>Berekening Recup:</strong>
        <ul>
          <li><u>Recup+</u> (toevoegen van overuren):
            <ul>
              <li>Dag: +50%</li>
              <li>Vroege: +55%</li>
              <li>Late: +65%</li>
              <li>Nacht: +100%</li>
            </ul>
          </li>
          <li><u>Recup−</u> (oppakken van overuren):
            <ul>
              <li>Dag: geen extra</li>
              <li>Vroege: +5%</li>
              <li>Late: +15%</li>
              <li>Nacht: +50%</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <div id="hoursDiv" class="inline-inputs">
      <input type="number" id="hours" min="0" max="24" placeholder="0">
      <span>uren en</span>
      <input type="number" id="minutes" min="0" max="59" placeholder="0">
      <span>minuten</span>
    </div>
    
    <div class="text-center">
      <label id="customLabel" class="hide">Bedrag (enkel voor bestellingen): 
        <input type="number" id="customAmount" step="0.01" value="0">
      </label>
    </div>

    <div class="form-submit-wrapper">
      <button type="submit">Toevoegen</button>
    </div>
  </form>
  
  <table id="logTable" class="styled-table">
    <thead>
      <tr>
        <th>Datum</th>
        <th>Type/Shift</th>
        <th>Uren</th>
        <th>Bedrag (€)</th>
        <th>Actie</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <p class="version-info">Versie 1.7.0</p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    // ==== GLOBAL CONSTANTS AND VARIABLES ====
    const LS_KEYS = {
        LOG: 'overurenLog',
        START_AMOUNT: 'startAmount',
        DAILY_WAGE: 'defaultDailyWage',
        LAST_EXPORT_WEEK: 'lastExportWeek'
    };
    const STANDARD_HOURS = 7.25; // Aantal standaard werkuren per dag
    const shiftBonuses = { dag: 0.5, vroeg: 0.55, laat: 0.65, nacht: 1.0 };
    const oppakBonuses = { dag: 0.0, vroeg: 0.05, laat: 0.15, nacht: 0.5 }; // Corrected 'laat' to 0.15

    let log = JSON.parse(localStorage.getItem(LS_KEYS.LOG) || '[]');
    // let startAmount is fetched locally where needed or managed via LS_KEYS.START_AMOUNT

    // DOM Element caching
    const form = document.getElementById('entryForm');
    const tbody = document.querySelector('#logTable tbody');
    const totalNet = document.getElementById('totalNet');
    const dateInput = document.getElementById('date');
    const shiftInput = document.getElementById('shift');
    const typeInput = document.getElementById('entryType');
    const warningBox = document.getElementById('warningBox');
    const exportStatusBox = document.getElementById('exportStatus');
    const infoBox = document.getElementById('infoBox');
    const startAmountDisplay = document.getElementById('startAmountDisplay');
    const wageAmountDisplay = document.getElementById('wageAmountDisplay');


    // ==== HELPER FUNCTIONS ====
    function editStartAmount() {
      const current = parseFloat(localStorage.getItem(LS_KEYS.START_AMOUNT)) || 0;
      const nieuw = prompt('Nieuw startbedrag:', current.toFixed(2));
      if (nieuw !== null && !isNaN(parseFloat(nieuw))) {
        localStorage.setItem(LS_KEYS.START_AMOUNT, parseFloat(nieuw));
        startAmountDisplay.textContent = parseFloat(nieuw).toFixed(2);
        renderTable();
      }
    }

    function editWage() {
      const current = parseFloat(localStorage.getItem(LS_KEYS.DAILY_WAGE)) || 0;
      const nieuw = prompt('Nieuw dagloon:', current.toFixed(2));
      if (nieuw !== null && !isNaN(parseFloat(nieuw))) {
        localStorage.setItem(LS_KEYS.DAILY_WAGE, parseFloat(nieuw));
        wageAmountDisplay.textContent = parseFloat(nieuw).toFixed(2);
        // Note: renderTable() is not called here as wage changes affect future entries, not past ones.
      }
    }

    function formatDate(d) {
      const [y, m, day] = d.split("-");
      return `${day}/${m}/${y}`;
    }

    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function toggleInfoBox() {
      infoBox.style.display = infoBox.style.display === 'block' ? 'none' : 'block';
    }

    // ==== CORE LOGIC FUNCTIONS ====
    function renderTable() {
      tbody.innerHTML = '';
      let totaal = 0;
      let currentStartAmount = parseFloat(localStorage.getItem(LS_KEYS.START_AMOUNT)) || 0;
      totaal += currentStartAmount;

      const sortedLog = [...log].sort((a, b) => b.datum.localeCompare(a.datum));

      sortedLog.forEach(entry => {
        const tr = document.createElement('tr');
        tr.className = entry.bedrag >= 0 ? 'positief' : 'negatief';
        // Find original index for deletion, as 'log' is unsorted.
        const originalIndex = log.findIndex(item => item === entry);
        tr.innerHTML = `
          <td>${formatDate(entry.datum)}</td>
          <td>${entry.type === 'bestelling' ? 'Bestelling' : entry.shift.charAt(0).toUpperCase() + entry.shift.slice(1)}</td>
          <td>${entry.uren?.toFixed(2) || ''}</td>
          <td>${entry.bedrag.toFixed(2)}</td>
          <td class="actions">
            <i class="fas fa-trash-alt" title="Verwijder" onclick="deleteEntry(${originalIndex})"></i>
          </td>
        `;
        tbody.appendChild(tr);
        totaal += entry.bedrag;
      });

      totalNet.textContent = totaal.toFixed(2);
      document.getElementById('totalsDisplay').className = 'totals ' + (totaal >= 0 ? 'positief' : 'negatief');
    }

    function deleteEntry(index) {
      if (!confirm('Weet je zeker dat je deze entry wilt verwijderen?')) return;
      log.splice(index, 1);
      localStorage.setItem(LS_KEYS.LOG, JSON.stringify(log));
      renderTable();
    }
    
    function checkExportStatus() {
      const today = new Date();
      const currentWeek = `${today.getFullYear()}-W${String(getWeekNumber(today)).padStart(2, '0')}`;
      const lastExport = localStorage.getItem(LS_KEYS.LAST_EXPORT_WEEK) || '';
      
      exportStatusBox.classList.remove('hide');
      if (lastExport === currentWeek) {
        exportStatusBox.textContent = '✅ Deze week is al een PDF geëxporteerd.';
        exportStatusBox.style.backgroundColor = '#d4edda';
        exportStatusBox.style.color = '#155724';
        exportStatusBox.style.border = '1px solid #c3e6cb';
      } else {
        exportStatusBox.textContent = '⚠️ Vergeet deze week je PDF-export niet!';
        exportStatusBox.style.backgroundColor = '#fff3cd';
        exportStatusBox.style.color = '#856404';
        exportStatusBox.style.border = '1px solid #ffeeba';
      }
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const grouped = {};

      log.forEach(entry => {
        const [year, month] = entry.datum.split('-');
        const key = `${year}-${month}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(entry);
      });

      let yPos = 10;
      let grandTotal = 0; // Not strictly needed if using finalTotalFromApp

      const currentStartAmount = parseFloat(localStorage.getItem(LS_KEYS.START_AMOUNT)) || 0;
      doc.text(`Startbedrag: €${currentStartAmount.toFixed(2)}`, 10, yPos);
      yPos += 10;
      
      Object.keys(grouped).sort().reverse().forEach(monthKey => {
        const entries = grouped[monthKey].sort((a, b) => b.datum.localeCompare(a.datum));
        const maandTotaal = entries.reduce((sum, e) => sum + e.bedrag, 0);
        
        if (yPos > 260) { // Check if new page is needed before month header
            doc.addPage();
            yPos = 10;
        }
        doc.text(`Maand: ${monthKey}  (Maandtotaal: €${maandTotaal.toFixed(2)})`, 10, yPos);
        yPos += 7; // Adjusted spacing

        const body = entries.map(e => [
          formatDate(e.datum),
          e.type === 'bestelling' ? 'Bestelling' : e.shift.charAt(0).toUpperCase() + e.shift.slice(1), // Capitalize shift
          e.uren?.toFixed(2) || '',
          `€${e.bedrag.toFixed(2)}`
        ]);

        doc.autoTable({
          head: [['Datum', 'Type/Shift', 'Uren', 'Bedrag (€)']],
          body,
          startY: yPos,
          styles: { fontSize: 9 }, // Slightly smaller font for more data
          headStyles: { fillColor: [0, 123, 255], textColor: 255 }, // Header style
          margin: { top: 5, left: 10, right: 10 }, // Adjusted margins
          didParseCell: function(data) {
            if (data.section === 'body' && data.column.index === 3) { // Bedrag column
              const value = parseFloat(data.cell.raw.replace('€', ''));
              if (!isNaN(value)) {
                if (value < 0) {
                  data.cell.styles.fillColor = [255, 230, 230]; // Light red
                  data.cell.styles.textColor = [220, 53, 69]; // Darker red
                } else if (value > 0) {
                  data.cell.styles.fillColor = [230, 255, 230]; // Light green
                  data.cell.styles.textColor = [40, 167, 69]; // Darker green
                }
              }
            }
          },
          didDrawPage: (data) => { yPos = data.cursor.y + 10; } // Update yPos after table draw
        });
        yPos = doc.lastAutoTable.finalY + 10; // More robust way to get yPos
      });
      
      const finalTotalFromApp = parseFloat(totalNet.textContent) || 0;

      if (yPos > 270) { // Check for new page before final total
        doc.addPage();
        yPos = 10;
      }
      doc.setFontSize(12);
      doc.text(`Eindtotaal (incl. startbedrag): €${finalTotalFromApp.toFixed(2)}`, 10, yPos);

      const today = new Date();
      const currentWeek = `${today.getFullYear()}-W${String(getWeekNumber(today)).padStart(2, '0')}`;
      localStorage.setItem(LS_KEYS.LAST_EXPORT_WEEK, currentWeek);
      checkExportStatus(); // Update status immediately

      doc.save(`overuren_tracker_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // ==== EVENT LISTENERS AND INITIALIZATION ====
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize blur toggle functionality
      document.querySelectorAll('.blur-toggle').forEach(el => {
        el.addEventListener('click', () => {
          el.classList.toggle('reveal');
        });
      });

      // Display initial start amount and wage
      const initialStart = parseFloat(localStorage.getItem(LS_KEYS.START_AMOUNT)) || 0;
      const initialWage = parseFloat(localStorage.getItem(LS_KEYS.DAILY_WAGE)) || 0;
      startAmountDisplay.textContent = initialStart.toFixed(2);
      wageAmountDisplay.textContent = initialWage.toFixed(2);
      
      // Set initial date input value to today
      dateInput.value = new Date().toISOString().split('T')[0];
      
      // Initial table render
      renderTable();
      
      // Check and display PDF export status
      checkExportStatus();

      // Listener to close infoBox when clicking outside
      document.addEventListener('click', function(event) {
        const icon = document.querySelector('.question-icon');
        if (infoBox && icon && !infoBox.contains(event.target) && !icon.contains(event.target)) {
          infoBox.style.display = 'none';
        }
      });

      // Register Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js') // Path relative to index.html
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      }
    });

    typeInput.addEventListener('change', () => {
      const isBestelling = typeInput.value === 'bestelling';
      document.getElementById('shiftLabel').classList.toggle('hide', isBestelling);
      document.getElementById('hoursDiv').classList.toggle('hide', isBestelling);
      document.getElementById('customLabel').classList.toggle('hide', !isBestelling);
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      
      // Clear previous warnings and hide box
      const warningContentHolder = warningBox.querySelector('p') ? warningBox.querySelector('p').parentElement : warningBox;
      
      // Remove existing <p> warning messages only
      const existingWarningParagraphs = warningContentHolder.querySelectorAll('p');
      existingWarningParagraphs.forEach(p => p.remove());
      
      const warnings = [];
      const type = typeInput.value;
      const hoursVal = document.getElementById('hours').value;
      const minutesVal = document.getElementById('minutes').value;

      if (type !== 'bestelling' && (hoursVal.trim() === '' || parseFloat(hoursVal) === 0) && (minutesVal.trim() === '' || parseFloat(minutesVal) === 0)) {
        warnings.push('Vul minstens uren of minuten in voor Recup.');
      }

      if (type !== 'bestelling') {
        const dagloonCheck = localStorage.getItem(LS_KEYS.DAILY_WAGE);
        if (!dagloonCheck || isNaN(parseFloat(dagloonCheck)) || parseFloat(dagloonCheck) <= 0) {
          warnings.push('Vul een geldig (positief) dagloon in via "Dagloon aanpassen".');
        }
      }

      if (type === 'bestelling') {
        const customVal = document.getElementById('customAmount').value;
        if (customVal.trim() === '' || isNaN(parseFloat(customVal)) || parseFloat(customVal) === 0) {
          warnings.push('Vul een geldig (niet-nul) bedrag in voor de bestelling.');
        }
      }

      if (warnings.length > 0) {
        // Ensure the static parts (icon, title, close button) are present or re-add them
        if (!warningBox.querySelector('strong')) {
            warningBox.innerHTML = `<strong><i class='fas fa-exclamation-triangle'></i> Waarschuwing</strong><button type="button" class="warning-box-close-btn" onclick="this.parentElement.classList.add('hide')">&times;</button>`;
        }
        
        warnings.forEach(w => {
            const p = document.createElement('p');
            p.textContent = w;
            warningBox.appendChild(p);
        });

        warningBox.style.backgroundColor = '#fff3cd';
        warningBox.style.border = '1px solid #ffeeba';
        warningBox.style.color = '#856404';
        warningBox.classList.remove('hide');
        return;
      }
      warningBox.classList.add('hide'); // Hide if no new warnings

      const datum = dateInput.value;
      const shift = shiftInput.value;
      const hours = parseFloat(document.getElementById('hours').value) || 0;
      const minutes = parseFloat(document.getElementById('minutes').value) || 0;
      const uren = hours + (minutes / 60);
      const dagloon = parseFloat(localStorage.getItem(LS_KEYS.DAILY_WAGE)) || 0; // Already validated
      const customAmount = parseFloat(document.getElementById('customAmount').value) || 0;

      let bedrag = 0;
      if (type === 'recupPlus') {
        bedrag = uren * (dagloon / STANDARD_HOURS) * (1 + shiftBonuses[shift]);
      } else if (type === 'recupMin') {
        bedrag = -uren * (dagloon / STANDARD_HOURS) * (1 + oppakBonuses[shift]);
      } else if (type === 'bestelling') {
        bedrag = -Math.abs(customAmount); // Ensure bestelling is always a negative value (cost)
      }

      log.push({ datum, type, shift, uren, bedrag });
      localStorage.setItem(LS_KEYS.LOG, JSON.stringify(log));
      
      renderTable();

      // Reset form fields for next entry
      form.reset(); // Resets all fields to their HTML-defined initial values
      dateInput.value = new Date().toISOString().split('T')[0]; // Set date to today
      document.getElementById('hours').value = '';
      document.getElementById('minutes').value = '';
      document.getElementById('customAmount').value = '0';
      
      // Restore last selected type and shift for convenience
      typeInput.value = type; 
      shiftInput.value = shift;
      
      typeInput.dispatchEvent(new Event('change')); // Trigger UI updates based on type
    });

  </script>
</body>
</html>